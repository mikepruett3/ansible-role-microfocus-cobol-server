---
- name: "Include OS-specific variables"
  include_vars: "{{ ansible_os_family }}.yml"

- name: "Gather the package facts"
  ansible.builtin.package_facts:
    manager: auto
  when: ansible_facts.packages is not defined

- name: "Host Setup/Changes"
  block:
  - name: "Disable SELinux"
    selinux:
      state: disabled
    register: reboot
  - name: "Add hosts entry for local host IP address"
    lineinfile:
      path: /etc/hosts
      insertafter: EOF
      line: "{{ ansible_default_ipv4.address }} {{ inventory_hostname }}  {{ inventory_hostname.split('.')[0] }}"
  - name: "Set systems Hostname"
    ansible.builtin.hostname:
      name: "{{ inventory_hostname }}"
    register: hostname
  - name: "Retrieve /tmp mount point Source"
    shell: findmnt --fstab --target '/tmp' | tail -n 1 | awk '{ print $2 }'
    register: src
  - name: "Retrieve /tmp mount point FSType"
    shell: findmnt --fstab --target '/tmp' | tail -n 1 | awk '{ print $4 }'
    register: fstype
  - name: "Configure default mount options on /tmp mount point"
    mount:
      path: /tmp
      src: "{{ src.stdout|string }}"
      opts: 'defaults'
      fstype: "{{ fstype.stdout|string }}"
      state: remounted
  - name: "Reboot host"
    reboot:
    when: reboot.reboot_required or hostname.changed

- name: "Install required packages"
  block:
    - name: "Install required packages, if not already installed (RHEL7)"
      package:
        name: "{{ item }}"
        state: present
      with_items:
        - pax
        - ksh
      when:
        - "item|string not in ansible_facts.packages"
        - ansible_os_family == 'RedHat'
        - ansible_distribution_major_version <= '7'
    - name: "Install required packages, if not already installed (RHEL8)"
      package:
        name: "{{ item }}"
        state: present
      with_items:
        - spax
        - ksh
        - glibc.i686
        - libgcc.i686
        - libstdc++.i686
        - glibc-devel.i686
      when:
        - "item|string not in ansible_facts.packages"
        - ansible_os_family == 'RedHat'
        - ansible_distribution_major_version == '8'
    - name: "Install Java Development Kit version 11, if not already installed"
      package:
        name: 'java-11-openjdk'
        #Oracle's JDK package = 'jdk-11.0.11'
        state: present
      when:
        - "'java-11-openjdk' not in ansible_facts.packages"
        # for Oracle's JDK package, uncomment the later & comment the prior
        #- "'jdk-11.0.11' not in ansible_facts.packages"

- name: "Setup Service Account"
  block:
    - name: "Check for service users homedir existence"
      stat:
        path: "{{ service_homedir }}"
      register: path
    - name: "Create service users group, if not already created"
      ansible.builtin.group:
        name: "{{ service_group }}"
        state: present
      register: group
    - name: "Create service user, if not already created"
      ansible.builtin.user:
        name: "{{ service_user }}"
        group: "{{ service_group }}"
        home: "{{ service_homedir }}/{{ service_user }}"
        generate_ssh_key: yes
        ssh_key_type: ed25519
        ssh_key_comment: "{{ service_user }}@{{ inventory_hostname }}"
        state: present
      when:
        - group.state
        - path.stat.exists
        - path.stat.isdir

- name: "Create required directories in the service users homedir"
  file:
    path: "{{ service_homedir }}/{{ service_user }}/{{ item }}"
    owner: "{{ service_user }}"
    group: "{{ service_group }}"
    state: directory
  with_items:
    - "data"
    - "data/tmp"
    - "udata"
    - "udata/tmp"
  when:
    - path.stat.exists
    - path.stat.isdir
